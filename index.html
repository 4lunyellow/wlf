<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬¸ åƒå•¥ï¼Ÿ - ç¾é£Ÿæ±ºç­–é¤Šæˆ (Pixel Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            user-select: none;
        }

        /* åƒç´ å­—é«”ç”¨æ–¼ç­‰ç´šå’Œæ•¸å­— */
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }

        /* å‹•ç•«å®šç¾© */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pixel-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }
        @keyframes shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, -2px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes eat-anim {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-bounce-pixel { animation: pixel-bounce 1s steps(2, end) infinite; }
        .animate-pop { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-eat { animation: eat-anim 0.2s linear; }

        /* UI å…ƒä»¶æ¨£å¼ */
        .btn-pushable {
            position: relative;
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
            outline-offset: 4px;
            transition: filter 250ms;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .shadow-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.25);
            transform: translateY(4px);
            transition: transform 100ms cubic-bezier(.3, .7, .4, 1);
        }
        .edge-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(to left, #2d3748 0%, #4a5568 8%, #4a5568 92%, #2d3748 100%);
        }
        .front-layer {
            display: block;
            position: relative;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1.1rem;
            color: white;
            background: #4a5568;
            transform: translateY(-6px);
            transition: transform 100ms cubic-bezier(.3, .7, .4, 1);
        }
        .btn-pushable:active .front-layer {
            transform: translateY(-2px);
        }
        .btn-pushable:active .shadow-layer {
            transform: translateY(2px);
        }
        .btn-pushable:focus:not(:focus-visible) { outline: none; }

        /* é¡è‰²è®Šé«” */
        .btn-primary .edge-layer { background: linear-gradient(to left, #d97706 0%, #f59e0b 8%, #f59e0b 92%, #d97706 100%); }
        .btn-primary .front-layer { background: #f59e0b; }
        
        .btn-success .edge-layer { background: linear-gradient(to left, #059669 0%, #10b981 8%, #10b981 92%, #059669 100%); }
        .btn-success .front-layer { background: #10b981; }

        /* é€²åº¦æ¢ */
        .progress-container {
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            height: 24px;
            border: 2px solid #374151;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: #fcd34d;
            width: 0%;
            transition: width 0.2s steps(10);
        }

        .hidden { display: none !important; }
        
        /* åƒç´ å°è©±æ¡† */
        .pixel-border {
            box-shadow: 
                -4px 0 0 0 #374151,
                4px 0 0 0 #374151,
                0 -4px 0 0 #374151,
                0 4px 0 0 #374151;
            margin: 4px;
        }

        /* é¤µé£ŸæŒ‰éˆ•å°ˆç”¨ */
        .btn-feed .front-layer {
            padding: 6px 12px;
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #92400e;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-feed:active .front-layer {
            background: #fde68a;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center text-gray-800 bg-gray-100">

    <!-- æ‰‹æ©Ÿå®¹å™¨ -->
    <div class="relative w-full h-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col md:rounded-3xl md:h-[90vh] md:border-8 md:border-gray-800">
        
        <!-- èƒŒæ™¯ (ç¶²æ ¼ç´™é¢¨æ ¼) -->
        <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px;">
        </div>

        <!-- =========== é é¢ 1: å‘½åé  =========== -->
        <div id="view-naming" class="flex-1 flex flex-col items-center justify-center p-8 z-10">
            <div class="text-6xl mb-6 animate-bounce-pixel">ğŸ¥š</div>
            <h1 class="text-xl font-bold mb-2 text-gray-800 font-pixel tracking-widest">FOOD.PET</h1>
            <p class="text-gray-500 mb-8 text-center text-sm">é¤Šä¸€éš»é›»å­é›ï¼Œå¹«ä½ æ±ºå®šåƒä»€éº¼</p>
            
            <div class="w-full max-w-xs space-y-4">
                <input type="text" id="input-pet-name" placeholder="è¼¸å…¥åå­—..." class="w-full px-4 py-3 rounded-none border-4 border-gray-800 focus:border-yellow-500 focus:outline-none text-center font-bold bg-gray-50">
                <button onclick="app.startGame()" class="btn-pushable btn-primary w-full mt-4">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer"></span>
                    <span class="front-layer font-bold tracking-widest">START</span>
                </button>
            </div>
        </div>

        <!-- =========== é é¢ 2: ä¸»ç•«é¢ =========== -->
        <div id="view-main" class="hidden flex-1 flex flex-col w-full h-full z-10 relative">
            
            <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
            <div class="px-5 py-4 flex justify-between items-start bg-white/90 border-b-4 border-gray-100 z-20">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 font-bold tracking-wider mb-1">NAME</span>
                    <span id="display-name" class="text-lg font-black text-gray-800 tracking-wide">å°é›</span>
                </div>
                
                <!-- é¤µé£ŸæŒ‰éˆ• (æ–°åŠŸèƒ½) -->
                <button onclick="app.feedPet()" id="btn-feed-action" class="btn-pushable btn-feed transform scale-90 origin-right">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer !bg-yellow-700"></span>
                    <span class="front-layer">
                        <span class="text-xl">ğŸš</span>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-[10px] font-bold opacity-70">FEED</span>
                            <span id="display-feed-stock" class="font-pixel text-lg">0</span>
                        </div>
                    </span>
                </button>
            </div>

            <!-- ç­‰ç´šèˆ‡é€²åº¦æ¢ -->
            <div class="px-6 mt-4 z-20">
                <div class="flex justify-between items-end mb-2">
                    <span id="display-level" class="font-pixel text-xs text-indigo-600">LV.1</span>
                    <span id="display-exp-text" class="font-pixel text-[10px] text-gray-400">0/10</span>
                </div>
                <div class="progress-container">
                    <div id="progress-fill" class="progress-bar"></div>
                    <!-- ç¶²æ ¼ç´‹ç†è¦†è“‹åœ¨é€²åº¦æ¢ä¸Š -->
                    <div class="absolute inset-0" style="background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.1) 50%); background-size: 10px 100%;"></div>
                </div>
            </div>

            <!-- ä¸­å¤®å°é›äº’å‹•å€ -->
            <div class="flex-1 relative flex items-center justify-center cursor-pointer overflow-hidden" onclick="app.pokePet()">
                <!-- å°è©±æ°£æ³¡ -->
                <div id="speech-bubble" class="absolute top-[10%] opacity-0 transform transition-all duration-200 bg-white px-4 py-3 border-4 border-gray-800 text-center max-w-[80%] z-10">
                    <p id="speech-text" class="text-gray-800 font-bold text-sm">PI-YO?</p>
                    <!-- åƒç´ å°å°¾å·´ -->
                    <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-b-4 border-r-4 border-gray-800 transform rotate-45"></div>
                </div>

                <!-- å°é›æ¸²æŸ“å€ (Pixel SVG) -->
                <div id="pet-container" class="w-64 h-64 flex items-center justify-center animate-bounce-pixel transition-transform duration-100">
                    <!-- SVG ç”± JS æ³¨å…¥ -->
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰éˆ•å€ -->
            <div class="p-6 pb-8 bg-white border-t-4 border-gray-100 z-20">
                <button onclick="app.showFoodSelection()" class="btn-pushable btn-primary w-full h-16">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer"></span>
                    <span class="front-layer flex items-center justify-center gap-3 text-xl font-bold tracking-widest">
                        <span>ğŸ½ï¸</span> æ¬¸ï¼Œåƒå•¥ï¼Ÿ
                    </span>
                </button>
            </div>
        </div>

        <!-- =========== é é¢ 3: é¸æ“‡åƒ¹ä½ =========== -->
        <div id="view-select" class="hidden absolute inset-0 bg-white z-30 flex flex-col">
            <div class="p-6 border-b-4 border-gray-100 flex items-center">
                <button onclick="app.goBackToMain()" class="text-gray-400 hover:text-gray-800 font-bold text-xl mr-4">&lt; BACK</button>
            </div>
            
            <div class="flex-1 p-6 flex flex-col gap-4 overflow-y-auto">
                <div class="text-center mb-2 font-bold text-gray-400">SELECT BUDGET</div>
                
                <!-- Tier 1 -->
                <button onclick="app.rollFood(1)" class="btn-pushable w-full group">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer !bg-gradient-to-l !from-green-600 !to-green-700"></span>
                    <span class="front-layer !bg-green-500 !text-white flex flex-col items-start text-left p-4 border-2 border-green-700">
                        <div class="flex justify-between w-full mb-1">
                            <span class="text-lg font-bold">ğŸª™ æœˆåº•è¦å®ˆè²¡</span>
                            <span class="font-pixel text-xs bg-black/20 px-2 py-1 rounded">&lt;120</span>
                        </div>
                    </span>
                </button>

                <!-- Tier 2 -->
                <button onclick="app.rollFood(2)" class="btn-pushable w-full mt-2">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer !bg-gradient-to-l !from-blue-600 !to-blue-700"></span>
                    <span class="front-layer !bg-blue-500 !text-white flex flex-col items-start text-left p-4 border-2 border-blue-700">
                        <div class="flex justify-between w-full mb-1">
                            <span class="text-lg font-bold">ğŸ± æœˆä¸­é †é †é</span>
                            <span class="font-pixel text-xs bg-black/20 px-2 py-1 rounded">120-250</span>
                        </div>
                    </span>
                </button>

                <!-- Tier 3 -->
                <button onclick="app.rollFood(3)" class="btn-pushable w-full mt-2">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer !bg-gradient-to-l !from-purple-600 !to-purple-700"></span>
                    <span class="front-layer !bg-purple-500 !text-white flex flex-col items-start text-left p-4 border-2 border-purple-700">
                        <div class="flex justify-between w-full mb-1">
                            <span class="text-lg font-bold">ğŸ¥‚ æœˆåˆæ„›è‡ªå·±</span>
                            <span class="font-pixel text-xs bg-black/20 px-2 py-1 rounded">250+</span>
                        </div>
                    </span>
                </button>
            </div>
        </div>

        <!-- =========== é é¢ 4: æŠ½ç±¤çµæœ =========== -->
        <div id="view-result" class="hidden absolute inset-0 bg-gray-900 z-40 flex flex-col items-center justify-center p-8 text-center animate-pop">
            <div class="mb-4 text-green-400 font-pixel text-xs animate-pulse">:: RESULT ::</div>
            
            <div class="bg-gray-800 p-8 rounded-xl border-4 border-gray-700 w-full mb-8 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMmQzNzQ4Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiM0YTU1NjgiLz4KPC9zdmc+')] opacity-20"></div>
                <div id="result-emoji" class="text-8xl mb-4 relative z-10 animate-bounce">ğŸ›</div>
                <h2 id="result-name" class="text-3xl font-black text-white relative z-10">æ—¥å¼å’–å“©</h2>
            </div>
            
            <div class="w-full space-y-3">
                <!-- åˆä½µå¾Œçš„ä¸»è¦æŒ‰éˆ• -->
                <button onclick="app.confirmAndSearch()" class="btn-pushable btn-success w-full">
                    <span class="shadow-layer"></span>
                    <span class="edge-layer"></span>
                    <span class="front-layer flex justify-center items-center gap-2 text-lg">
                        <span>ğŸ“</span> æœå°‹ä¸¦é–‹å‹•ï¼
                    </span>
                </button>
                
                <button onclick="app.retryFood()" class="text-gray-500 hover:text-white mt-4 text-sm font-bold tracking-widest">
                    RETRY
                </button>
            </div>
        </div>

        <!-- =========== é é¢ 5: å‡ç´š/é€²åŒ–é€šçŸ¥ =========== -->
        <div id="view-levelup" class="hidden absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-8 text-center">
            <div class="relative mb-8">
                <div class="absolute inset-0 bg-yellow-400 blur-2xl opacity-20 animate-pulse"></div>
                <div id="levelup-icon" class="relative text-8xl animate-bounce">ğŸ£</div>
            </div>
            
            <h2 class="text-3xl font-pixel text-yellow-400 mb-4 tracking-widest">LEVEL UP!</h2>
            <p id="levelup-msg" class="text-white text-lg mb-12 font-bold">é€²åŒ–æˆ ç ´æ®¼æœŸ äº†ï¼</p>
            
            <button onclick="app.closeLevelUp()" class="btn-pushable btn-primary px-8">
                <span class="shadow-layer"></span>
                <span class="edge-layer"></span>
                <span class="front-layer">COOL!</span>
            </button>
        </div>

    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        const FOOD_DB = {
            1: [
                { name: "ä¾¿ç•¶", emoji: "ğŸ±" }, { name: "éºµåº—", emoji: "ğŸœ" }, { name: "æ°´é¤ƒ", emoji: "ğŸ¥Ÿ" }, 
                { name: "æ—©é¤", emoji: "ğŸ¥ª" }, { name: "ç‚’é£¯", emoji: "ğŸ›" }, { name: "æ¶¼éºµ", emoji: "ğŸ¥—" }, 
                { name: "ä¾¿åˆ©å•†åº—", emoji: "ğŸª" }, { name: "é£¯ç³°", emoji: "ğŸ™" }, { name: "æ»·å‘³", emoji: "ğŸ¥˜" }, 
                { name: "ç²¥", emoji: "ğŸ¥£" }, { name: "è‡ªåŠ©é¤", emoji: "ğŸ½ï¸" }, { name: "å°åƒåº—", emoji: "ğŸ¥¢" }, 
                { name: "ç”œä¸è¾£/è‚‰åœ“", emoji: "ğŸ¡" }, { name: "è¶Šå—å°åƒ", emoji: "ğŸ‡»ğŸ‡³" }, { name: "è‚‰ç¾¹", emoji: "ğŸ²" }, 
                { name: "ç«é›è‚‰é£¯", emoji: "ğŸš" }, { name: "æ»·è‚‰é£¯", emoji: "ğŸš" }, { name: "ç±³ç²‰æ¹¯", emoji: "ğŸœ" }, 
                { name: "æ½¤é¤…", emoji: "ğŸŒ¯" }, { name: "é‹ç‡’æ„éºµ", emoji: "ğŸ²" }
            ],
            2: [
                { name: "é€Ÿé£Ÿ", emoji: "ğŸ”" }, { name: "ä¸¼é£¯", emoji: "ğŸ›" }, { name: "ç¾©å¤§åˆ©éºµ", emoji: "ğŸ" }, 
                { name: "å¥åº·é¤ç›’", emoji: "ğŸ¥—" }, { name: "æ¸¯å¼ç‡’è‡˜", emoji: "ğŸ–" }, { name: "çƒé¾éºµ", emoji: "ğŸœ" }, 
                { name: "æ—¥å¼å’–å“©", emoji: "ğŸ›" }, { name: "éŸ“å¼æ–™ç†", emoji: "ğŸ‡°ğŸ‡·" }, { name: "æ½›è‰‡å ¡", emoji: "ğŸ¥ª" }, 
                { name: "æ³°å¼æ–™ç†", emoji: "ğŸ‡¹ğŸ‡­" }, { name: "è¶Šå¼æ–™ç†", emoji: "ğŸ‡»ğŸ‡³" }, { name: "éº»è¾£ç‡™", emoji: "ğŸŒ¶ï¸" }, 
                { name: "å£½å¸", emoji: "ğŸ£" }, { name: "ç‰›è‚‰éºµ", emoji: "ğŸœ" }, { name: "æµ·å—é›é£¯", emoji: "ğŸš" }, 
                { name: "è›‹åŒ…é£¯", emoji: "ğŸ³" }, { name: "æ¼¢å ¡", emoji: "ğŸ”" }, { name: "æ‹‰éºµ", emoji: "ğŸœ" }, 
                { name: "å¹³åƒ¹éµæ¿ç‡’", emoji: "ğŸ¥©" }
            ],
            3: [
                { name: "æ—¥å¼å®šé£Ÿ", emoji: "ğŸ±" }, { name: "ç”Ÿé­šç‰‡ä¸¼", emoji: "ğŸŸ" }, { name: "é°»é­šé£¯", emoji: "ğŸ±" }, 
                { name: "ç¾å¼æ¼¢å ¡", emoji: "ğŸ”" }, { name: "æ³°å¼é¤å»³", emoji: "ğŸ‡¹ğŸ‡­" }, { name: "è¶Šå¼é¤å»³", emoji: "ğŸ‡»ğŸ‡³" }, 
                { name: "éŸ“å¼é¤å»³", emoji: "ğŸ‡°ğŸ‡·" }, { name: "å°åº¦æ–™ç†", emoji: "ğŸ‡®ğŸ‡³" }, { name: "æŠ«è–©", emoji: "ğŸ•" }, 
                { name: "æ¸¯å¼é£²èŒ¶", emoji: "ğŸ¥Ÿ" }, { name: "ç‚¸è±¬æ’", emoji: "ğŸ·" }, { name: "ç¾©å¼é¤å»³", emoji: "ğŸ" }, 
                { name: "ç‰›æ’", emoji: "ğŸ¥©" }, { name: "æ‹‰éºµå°ˆé–€åº—", emoji: "ğŸœ" }, { name: "å’–å•¡å»³", emoji: "â˜•" }, 
                { name: "å€‹äººç‡’è‚‰", emoji: "ğŸ”¥" }, { name: "ç«é‹", emoji: "ğŸ²" }, { name: "æ—©åˆé¤", emoji: "ğŸ¥" }, 
                { name: "é…¸èœé­š", emoji: "ğŸŸ" }
            ]
        };

        const LEVEL_TITLES = {
            0: "åˆå§‹é›è›‹", 1: "ç ´æ®¼æœŸ", 2: "æ¢é ­æœŸ", 3: "åŠæ®¼æœŸ", 4: "è„«æ®¼æœŸ",
            5: "æ›æ¯›æœŸ", 6: "å°‘å¹´æœŸ", 7: "é’å¹´æœŸ", 8: "æˆç†ŸæœŸ", 9: "éœ¸ä¸»æœŸ", 10: "é»ƒé‡‘å…¬é›"
        };

        const DIALOGUES = {
            low: ["...", "Zzz", "Hungry", "Warm"],
            mid: ["Pi-Yo!", "Feed me!", "Food?", "Hello!", "Grow!"],
            high: ["KUKU!", "Strong!", "Boss!", "Look!", "Golden!"]
        };

        class App {
            constructor() {
                this.state = {
                    name: "",
                    level: 0,
                    exp: 0,
                    feedStock: 0, // æ–°å¢ï¼šé£¼æ–™åº«å­˜
                    history: [],
                    lastTier: 1
                };

                this.views = {
                    naming: document.getElementById('view-naming'),
                    main: document.getElementById('view-main'),
                    select: document.getElementById('view-select'),
                    result: document.getElementById('view-result'),
                    levelup: document.getElementById('view-levelup')
                };

                this.els = {
                    inputName: document.getElementById('input-pet-name'),
                    displayName: document.getElementById('display-name'),
                    displayFeedStock: document.getElementById('display-feed-stock'), // æ›´æ–°
                    displayLevel: document.getElementById('display-level'),
                    displayExpText: document.getElementById('display-exp-text'),
                    progressFill: document.getElementById('progress-fill'),
                    petContainer: document.getElementById('pet-container'),
                    resultName: document.getElementById('result-name'),
                    resultEmoji: document.getElementById('result-emoji'),
                    speechBubble: document.getElementById('speech-bubble'),
                    speechText: document.getElementById('speech-text'),
                    levelUpMsg: document.getElementById('levelup-msg'),
                    levelUpIcon: document.getElementById('levelup-icon')
                };

                this.tempFood = null;

                this.loadData();
                this.init();
            }

            init() {
                if (this.state.name) {
                    this.showView('main');
                    this.renderUI();
                } else {
                    this.showView('naming');
                }
            }

            showView(viewName) {
                Object.values(this.views).forEach(el => el.classList.add('hidden'));
                this.views[viewName].classList.remove('hidden');
            }

            saveData() {
                localStorage.setItem('pet_game_pixel_v2', JSON.stringify(this.state));
            }

            loadData() {
                const data = localStorage.getItem('pet_game_pixel_v2');
                if (data) {
                    this.state = { ...this.state, ...JSON.parse(data) };
                }
            }

            getMaxExp(level) {
                if (level === 0) return 0;
                return level * 10;
            }

            startGame() {
                const name = this.els.inputName.value.trim();
                if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
                this.state.name = name;
                this.state.level = 1; 
                this.state.exp = 0;
                this.state.feedStock = 0;
                this.saveData();
                this.init();
            }

            renderUI() {
                this.els.displayName.textContent = this.state.name;
                this.els.displayLevel.textContent = this.state.level >= 10 ? 'MAX' : `LV.${this.state.level}`;
                
                let maxExp = this.getMaxExp(this.state.level);
                if (this.state.level >= 10 && this.state.exp >= 100) {
                     this.els.displayExpText.textContent = "MAX";
                     this.els.progressFill.style.width = "100%";
                     this.els.displayLevel.classList.add('text-yellow-500');
                     this.els.displayLevel.textContent = "KING";
                } else {
                    this.els.displayExpText.textContent = `${this.state.exp}/${maxExp}`;
                    const pct = Math.min(100, (this.state.exp / maxExp) * 100);
                    this.els.progressFill.style.width = `${pct}%`;
                }

                // æ›´æ–°é£¼æ–™åº«å­˜é¡¯ç¤º
                this.els.displayFeedStock.textContent = this.state.feedStock;
                
                this.renderPetSVG();
            }

            showFoodSelection() {
                this.showView('select');
            }

            goBackToMain() {
                this.showView('main');
            }

            rollFood(tier) {
                this.state.lastTier = tier;
                const pool = FOOD_DB[tier];
                let candidates = pool.filter(f => !this.state.history.includes(f.name));
                if (candidates.length === 0) candidates = pool;
                const choice = candidates[Math.floor(Math.random() * candidates.length)];
                this.tempFood = choice;
                this.els.resultEmoji.textContent = choice.emoji;
                this.els.resultName.textContent = choice.name;
                this.showView('result');
            }

            retryFood() {
                this.rollFood(this.state.lastTier);
            }

            // åˆä½µåŠŸèƒ½ï¼šæœå°‹ä¸¦ç¢ºèª
            confirmAndSearch() {
                if (!this.tempFood) return;
                
                // 1. é–‹å•Ÿ Google Maps
                const query = encodeURIComponent(this.tempFood.name);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');

                // 2. åŸ·è¡Œç¢ºèªé‚è¼¯ (ç²å¾—é£¼æ–™)
                this.state.history.push(this.tempFood.name);
                if (this.state.history.length > 3) this.state.history.shift();

                this.state.feedStock += 1;
                
                this.saveData();
                this.showView('main');
                this.renderUI();
                
                // é¡¯ç¤ºç²å¾—é£¼æ–™æç¤º (ç¨å¾®å»¶é²ä¸€é»é»ï¼Œè®“ä½¿ç”¨è€…åˆ‡å›ä¾†æ™‚å‰›å¥½çœ‹åˆ°)
                setTimeout(() => {
                    this.showFloatingText("GET ğŸš", "#10b981");
                }, 500);
            }

            // æ–°åŠŸèƒ½ï¼šæ‰‹å‹•é¤µé£Ÿ
            feedPet() {
                if (this.state.feedStock <= 0) {
                    this.showFloatingText("NO FOOD!", "#ef4444");
                    return;
                }

                if (this.state.level >= 10 && this.state.exp >= 100) {
                     this.showFloatingText("FULL!", "#f59e0b");
                     return;
                }

                // æ‰£é™¤åº«å­˜ï¼Œå¢åŠ ç¶“é©—
                this.state.feedStock--;
                this.state.exp++;
                
                // å‹•ç•«æ•ˆæœ
                this.els.petContainer.classList.add('animate-eat');
                setTimeout(() => this.els.petContainer.classList.remove('animate-eat'), 200);
                this.showFloatingText("YUMMY!", "#f59e0b");

                this.checkLevelUp();
                this.saveData();
                this.renderUI();
            }

            showFloatingText(text, color) {
                const el = document.createElement('div');
                el.textContent = text;
                el.className = "absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 font-pixel text-xl font-bold animate-pop pointer-events-none z-50 shadow-sm";
                el.style.color = color;
                el.style.textShadow = "2px 2px 0px #fff";
                this.views.main.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }

            checkLevelUp() {
                const max = this.getMaxExp(this.state.level);
                if (this.state.exp >= max) {
                    if (this.state.level < 10) {
                        this.state.level++;
                        this.state.exp = 0;
                        this.triggerLevelUpView();
                    } else if (this.state.level === 10 && this.state.exp === 100) {
                         this.triggerLevelUpView(true);
                    }
                }
            }

            triggerLevelUpView(isGolden = false) {
                const title = isGolden ? "é»ƒé‡‘å…¬é›" : LEVEL_TITLES[this.state.level];
                this.els.levelUpMsg.textContent = isGolden 
                    ? "LEGENDARY! GOLDEN ROOSTER!" 
                    : `EVOLVED TO ${title}!`;
                this.els.levelUpIcon.textContent = isGolden ? "ğŸŒŸ" : "ğŸ£";
                this.views.levelup.classList.remove('hidden');
                if(isGolden) confettiEffect();
            }

            closeLevelUp() {
                this.views.levelup.classList.add('hidden');
                this.renderUI();
            }

            pokePet() {
                const pet = document.getElementById('pet-pixel-art');
                if(pet) {
                    pet.style.animation = 'shake 0.5s';
                    setTimeout(() => pet.style.animation = '', 500);
                }

                let pool = DIALOGUES.mid;
                if (this.state.level <= 3) pool = DIALOGUES.low;
                if (this.state.level >= 8) pool = DIALOGUES.high;
                
                const text = pool[Math.floor(Math.random() * pool.length)];
                this.els.speechText.textContent = text;
                
                this.els.speechBubble.classList.remove('opacity-0');
                this.els.speechBubble.style.transform = 'translateY(-10px)';
                
                if (this.speechTimeout) clearTimeout(this.speechTimeout);
                this.speechTimeout = setTimeout(() => {
                    this.els.speechBubble.classList.add('opacity-0');
                    this.els.speechBubble.style.transform = 'translateY(0)';
                }, 2000);
            }

            // PIXEL ART RENDERER
            // ä½¿ç”¨ SVG rect æ¨¡æ“¬åƒç´ é»
            drawPixel(x, y, color, size=10) {
                return `<rect x="${x*size}" y="${y*size}" width="${size}" height="${size}" fill="${color}" />`;
            }

            renderPetSVG() {
                const lv = this.state.level;
                const isGolden = (lv === 10 && this.state.exp >= 100);
                
                // èª¿è‰²ç›¤
                const c = {
                    body: isGolden ? "#FCD34D" : (lv < 4 ? "#FEF3C7" : "#F59E0B"), // é‡‘/æ·ºé»ƒ/æ·±é»ƒ
                    outline: isGolden ? "#B45309" : "#374151", // è¼ªå»“
                    beak: "#F97316",
                    comb: "#EF4444",
                    eye: "#1F2937",
                    shell: "#F3F4F6",
                    shadow: "rgba(0,0,0,0.1)"
                };

                let pixels = [];
                const size = 10; // æ¯å€‹åƒç´ çš„å¤§å°

                // ç¹ªè£½åŠ©æ‰‹å‡½æ•¸
                const p = (x, y, col) => pixels.push(this.drawPixel(x, y, col, size));
                
                // åŸºç¤å°é›å½¢ç‹€ (8x8 grid mapped to coordinate)
                // æˆ‘å€‘å®šç¾©ä¸€å€‹ 16x16 çš„ç•«å¸ƒä¸­å¿ƒ
                
                if (lv <= 3) {
                    // è›‹/ç ´æ®¼éšæ®µ
                    // è›‹æ®¼
                    [4,5,6,7,8,9,10,11].forEach(x => [9,10,11,12].forEach(y => p(x,y,c.shell)));
                    // è¼ªå»“
                    p(5,8,c.outline); p(6,8,c.outline); p(9,8,c.outline); p(10,8,c.outline); // è£‚ç¸«
                    p(4,9,c.outline); p(3,10,c.outline); p(3,11,c.outline); p(4,12,c.outline);
                    p(11,9,c.outline); p(12,10,c.outline); p(12,11,c.outline); p(11,12,c.outline);
                    p(5,13,c.outline); p(6,13,c.outline); p(7,13,c.outline); p(8,13,c.outline); p(9,13,c.outline); p(10,13,c.outline);
                    
                    if (lv >= 2) {
                        // éœ²é ­
                        [5,6,7,8,9,10].forEach(x => [6,7,8].forEach(y => p(x,y,c.body)));
                        p(6,7,c.eye); p(9,7,c.eye); // çœ¼ç›
                    } else {
                        // è›‹é ‚
                        [5,6,7,8,9,10].forEach(x => [6,7,8].forEach(y => p(x,y,c.shell)));
                    }

                } else if (lv <= 6) {
                    // å¹¼å¹´/å°‘å¹´æœŸ (åœ“å½¢)
                    // èº«é«”
                    [5,6,7,8,9,10].forEach(x => [5,6,7,8,9,10].forEach(y => p(x,y,c.body)));
                    // è¼ªå»“ä¿®é£¾ (è®“å®ƒåœ“ä¸€é»)
                    p(4,6,c.body); p(4,7,c.body); p(4,8,c.body); p(4,9,c.body);
                    p(11,6,c.body); p(11,7,c.body); p(11,8,c.body); p(11,9,c.body);
                    
                    // çœ¼ç›
                    p(6,7,c.eye); p(9,7,c.eye);
                    // å˜´å·´
                    p(7,8,c.beak); p(8,8,c.beak);
                    // è…³
                    p(6,11,c.outline); p(9,11,c.outline);

                    if (lv >= 5) {
                        // å°é›å† 
                        p(7,4,c.comb); p(8,4,c.comb);
                    }
                } else {
                    // æˆå¹´æœŸ (å…¬é›å½¢ç‹€)
                    // èº«é«”
                    [5,6,7,8,9,10].forEach(x => [6,7,8,9,10].forEach(y => p(x,y,c.body)));
                    // å°¾å·´
                    p(4,7,c.comb); p(3,6,c.comb); p(3,7,c.comb);
                    if (lv >= 9) { p(2,5,c.comb); p(2,6,c.comb); } // å¤§å°¾å·´

                    // é›å† 
                    p(7,5,c.comb); p(8,5,c.comb); p(9,5,c.comb);
                    p(8,4,c.comb);
                    
                    // çœ¼ç›
                    p(9,7,c.eye);
                    // å˜´å·´
                    p(11,8,c.beak);
                    // ç¿…è†€
                    p(7,8,c.outline); p(6,8,c.outline);

                    // è…³
                    p(7,11,c.outline); p(9,11,c.outline);
                }

                const svgString = `
                    <svg id="pet-pixel-art" width="200" height="200" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <g transform="translate(0, 10)">
                            ${pixels.join('')}
                        </g>
                    </svg>
                `;
                
                this.els.petContainer.innerHTML = svgString;
            }
        }

        function confettiEffect() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'fixed';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.width = '8px';
                conf.style.height = '8px';
                conf.style.backgroundColor = ['#FFD700', '#EF4444', '#3B82F6'][Math.floor(Math.random()*3)];
                conf.style.zIndex = '9999';
                conf.style.transition = `transform ${Math.random()*2+1}s linear`;
                document.body.appendChild(conf);
                setTimeout(() => {
                    conf.style.transform = `translateY(100vh) rotate(720deg)`;
                    conf.style.opacity = 0;
                }, 100);
                setTimeout(() => conf.remove(), 3000);
            }
        }

        const app = new App();
    </script>
</body>
</html>